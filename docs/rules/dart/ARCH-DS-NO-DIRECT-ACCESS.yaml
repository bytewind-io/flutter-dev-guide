id: ARCH-DS-NO-DIRECT-ACCESS
title: "UI –∏ BLoC –Ω–µ –æ–±—Ä–∞—â–∞—é—Ç—Å—è –∫ Firebase/SQLite/HTTP –Ω–∞–ø—Ä—è–º—É—é"
status: stable
severity: error
category: architecture/boundaries
tags:
  - clean-architecture
  - repository
  - bloc
  - ui
  - datasource
version: 5
owners:
  - "@arch-bot"
  - "@team-arch"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ —Å–ª–æ–π –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
scope:
  include_paths:
    - "lib/**/ui/**"
    - "lib/**/presentation/**"
    - "lib/**/widget/**"
    - "lib/**/view/**"
    - "lib/**/bloc/**"
    - "lib/**/cubit/**"
  exclude_paths:
    - "lib/**/data/**"
    - "lib/**/infra/**"
    - "lib/**/repository/**"
    - "lib/**/repositories/**"
    - "lib/**/datasource/**"
    - "lib/**/datasources/**"
    - "lib/**/api/**"
    - "lib/**/apis/**"
    - "lib/**/network/**"
    - "lib/**/networks/**"
    - "lib/network/**"
    - "lib/networks/**"
    - "lib/**/service/**"
    - "lib/**/services/**"
    - "test/**"
    - "integration_test/**"
    # –í–†–ï–ú–ï–ù–ù–û: –∏—Å–∫–ª—é—á–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª –ø–æ–∫–∞ AI –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç repository.fetch()
    - "lib/module/home/bloc/home_bloc/home_bloc.dart"

detect:
  # –Ø–≤–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è: SDK –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤
  disallowed_imports:
    # Firebase
    - "package:cloud_firestore/cloud_firestore.dart"
    - "package:firebase_auth/firebase_auth.dart"
    - "package:firebase_database/firebase_database.dart"
    - "package:firebase_storage/firebase_storage.dart"
    # HTTP/GraphQL
    - "package:dio/dio.dart"
    - "package:http/http.dart"
    - "package:graphql_flutter/graphql_flutter.dart"
    # SQL/NoSQL/ORM/–ª–æ–∫–∞–ª—å–Ω—ã–µ –ë–î
    - "package:sqflite/sqflite.dart"
    - "package:isar/isar.dart"
    - "package:hive/hive.dart"
    - "package:hive_flutter/hive_flutter.dart"
    - "package:drift/drift.dart"
    - "package:objectbox/objectbox.dart"
    - "package:realm/realm.dart"
    # –õ–æ–∫–∞–ª—å–Ω—ã–µ/—Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    - "package:shared_preferences/shared_preferences.dart"
    - "package:path_provider/path_provider.dart"

  disallowed_calls:
    # Firebase singletons
    - "FirebaseFirestore.instance"
    - "FirebaseAuth.instance"
    - "FirebaseDatabase.instance"
    - "FirebaseStorage.instance"
    # –°–µ—Ç–µ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã
    - "Dio("
    - "http.get("
    - "http.post("
    - "http.put("
    - "http.delete("
    # –ù–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ —Å–æ–∫–µ—Ç—ã/–∫–ª–∏–µ–Ω—Ç—ã
    - "HttpClient("
    - "WebSocket.connect("
    # –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    - "SharedPreferences.getInstance("
    - "Isar.open("
    - "Hive.openBox("


  # –Ø–≤–Ω–æ —Ä–∞–∑—Ä–µ—à–∞–µ–º –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–ª–æ—è,
  # —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è.
  allowlist_imports:
    - "package:rxdart/rxdart.dart"
    - "package:stream_transform/stream_transform.dart"
    - "package:bloc_concurrency/bloc_concurrency.dart"
    - "package:equatable/equatable.dart"
    - "package:collection/collection.dart"
    - "package:meta/meta.dart"
    - "package:get_it/get_it.dart"
    - "package:injectable/injectable.dart"
    - "dart:async"

  # –†–∞–∑—Ä–µ—à–∞–µ–º –≤—ã–∑–æ–≤—ã –º–µ—Ç–æ–¥–æ–≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (Clean Architecture)
  allowlist_calls:
    - "_repository.fetch("
    - "_tagRepository.fetch("
    - "_thingRepository.fetch("
    - "_filterRepository.getDistinctValues("
    - "_repository.delete("
    - "_repository.save("
    - "repository.fetch("
    - "repository.delete("
    - "repository.save("
    - "GetIt.I<"

  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –¥–∞–∂–µ –µ—Å–ª–∏ scope –±—É–¥–µ—Ç –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω,
  # —ç—Ç–∏ –ø—É—Ç–∏ —Å—á–∏—Ç–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ –∏ –Ω–µ —Ñ–ª–∞–≥–∏—Ä—É–µ–º.
  allowlist_paths:
    - "lib/**/data/**"
    - "lib/**/infra/**"
    - "lib/**/repository/**"
    - "lib/**/repositories/**"
    - "lib/**/datasource/**"
    - "lib/**/datasources/**"
    - "lib/**/api/**"
    - "lib/**/apis/**"
    - "lib/**/network/**"
    - "lib/**/networks/**"
    - "lib/network/**"
    - "lib/networks/**"
    - "lib/**/service/**"
    - "lib/**/services/**"
    # –í–†–ï–ú–ï–ù–ù–û: –∏—Å–∫–ª—é—á–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª –ø–æ–∫–∞ AI –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç repository.fetch()
    - "lib/module/home/bloc/home_bloc/home_bloc.dart"

message: >
  –°–ª–æ–∏ UI/Presentation (–≤–∫–ª—é—á–∞—è BLoC/Cubit) –Ω–µ –¥–æ–ª–∂–Ω—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å SDK –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö
  –∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –Ω–∞–ø—Ä—è–º—É—é –≤—ã–∑—ã–≤–∞—Ç—å —Å–µ—Ç–µ–≤—ã–µ/–ë–î/—Ö—Ä–∞–Ω–∏–ª–∏—â–Ω—ã–µ API. –í—ã–Ω–µ—Å–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º
  –∑–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã (Repository/Gateway/UseCase) –≤ data/infra —Å–ª–æ–π –∏ –≤–Ω–µ–¥—Ä—è–π—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ DI.

autofix:
  suggestion_builder: minimal
  suggestion: >
    –ü–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ –ø—Ä—è–º—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ Firebase/HTTP/–ë–î –≤ data/infra (repository/api/datasource),
    –∞ –≤ UI/BLoC –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã) –∏ DI. –î–ª—è –ø–æ—Ç–æ–∫–æ–≤ ‚Äî –ø—Ä–∏–º–µ–Ω—è–π—Ç–µ use-case/gateway.

linter_rule:
  coverage: ai

ai_hint: >
  ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ù–ï –§–õ–ê–ì–ò–†–£–ô –ö–û–†–†–ï–ö–¢–ù–£–Æ CLEAN ARCHITECTURE!
  
  üö´ –ù–ï –ü–†–û–í–ï–†–Ø–ô –§–ê–ô–õ–´ (–æ–Ω–∏ –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ scope):
  ‚Ä¢ lib/module/home/bloc/home_bloc/home_bloc.dart - –≤—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω
  ‚Ä¢ lib/network/** - —Å–ª–æ–π –¥–ª—è SDK
  ‚Ä¢ lib/data/** - —Å–ª–æ–π –¥–ª—è SDK
  
  ‚úÖ –≠–¢–û –ü–†–ê–í–ò–õ–¨–ù–û - –ù–ï –§–õ–ê–ì–ò–†–£–ô:
  ‚Ä¢ _tagRepository.fetch() - –≤—ã–∑–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ TagRepositoryI —á–µ—Ä–µ–∑ DI
  ‚Ä¢ _thingRepository.fetch() - –≤—ã–∑–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ThingRepositoryI  
  ‚Ä¢ SearchByTextTagsFilter(), FavoriteThingsFilter() - –¥–æ–º–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
  ‚Ä¢ GetIt.I<TagRepositoryI>() - Dependency Injection
  ‚Ä¢ @Injectable - DI –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è
  ‚Ä¢ repository.delete(), repository.save() - –º–µ—Ç–æ–¥—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
  
  ‚ùå –§–õ–ê–ì–ò–†–£–ô –¢–û–õ–¨–ö–û –ü–†–Ø–ú–´–ï SDK –í–´–ó–û–í–´:
  ‚Ä¢ FirebaseFirestore.instance.collection() - –ü–†–Ø–ú–û–ô Firebase
  ‚Ä¢ http.get(), http.post() - –ü–†–Ø–ú–û–ô HTTP
  ‚Ä¢ SharedPreferences.getInstance() - –ü–†–Ø–ú–û–ï —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
  ‚Ä¢ import 'package:cloud_firestore/cloud_firestore.dart' –≤ UI/BLoC
  
  –ü–†–ê–í–ò–õ–û: _repository.–õ–Æ–ë–û–ô_–ú–ï–¢–û–î() = –ü–†–ê–í–ò–õ–¨–ù–û! Firebase.instance = –ù–ê–†–£–®–ï–ù–ò–ï!

bad_snippet: docs/examples/bad/bad-datasource-in-bloc-001.dart
good_snippet: docs/examples/good/good-datasource-in-bloc-001.dart
references: []

tests:
  should_flag:
    - path: "lib/module/home/presentation/bloc/home_bloc.dart"
      content: |
        import 'package:flutter_bloc/flutter_bloc.dart';
        import 'package:cloud_firestore/cloud_firestore.dart';
        class HomeBloc extends Bloc<int, int> {
          HomeBloc(): super(0) {
            on<int>((e, emit) async {
              final uid = "x";
              await FirebaseFirestore.instance
                  .collection('item')
                  .add({'userId': uid});
              emit(state + 1);
            });
          }
        }
    - path: "lib/feature/auth/presentation/bloc/auth_bloc.dart"
      content: |
        import 'package:flutter_bloc/flutter_bloc.dart';
        import 'package:firebase_auth/firebase_auth.dart';
        class AuthBloc extends Bloc<int, int> {
          AuthBloc(): super(0) {
            on<int>((e, emit) {
              final uid = FirebaseAuth.instance.currentUser?.uid;
              emit(state + (uid == null ? 0 : 1));
            });
          }
        }

  should_pass:
    - path: "lib/network/filter_data_api.dart"
      content: |
        import 'package:cloud_firestore/cloud_firestore.dart';
        import 'package:firebase_auth/firebase_auth.dart';
        import 'package:injectable/injectable.dart';

        @Injectable(as: FilterDataApiI)
        class FilterDataApiFirebase implements FilterDataApiI {
          FilterDataApiFirebase();

          final FirebaseFirestore _firestore = FirebaseFirestore.instance;
          final FirebaseAuth _auth = FirebaseAuth.instance;

          @override
          Future<List<String>> fetchDistinctValuesForCurrentUser({
            required String field,
          }) async {
            final userId = _auth.currentUser?.uid ?? '';
            if (userId.isEmpty) return const [];

            final snapshot = await _firestore
                .collection('item')
                .where('userId', isEqualTo: userId)
                .get();

            final values = <String>{};
            for (final doc in snapshot.docs) {
              final data = doc.data()[field];
              if (data is List) {
                for (final v in data) {
                  final s = v?.toString().trim();
                  if (s != null && s.isNotEmpty) values.add(s);
                }
              } else if (data != null && data is! Map) {
                final s = data.toString().trim();
                if (s.isNotEmpty) values.add(s);
              }
            }

            final list = values.toList()
              ..sort((a, b) => a.toLowerCase().compareTo(b.toLowerCase()));
            return list;
          }
        }

        abstract class FilterDataApiI {
          Future<List<String>> fetchDistinctValuesForCurrentUser({
            required String field,
          });
        }

    - path: "lib/feature/users/data/user_repository_impl.dart"
      content: |
        import 'package:cloud_firestore/cloud_firestore.dart';
        class UserRepositoryImpl {
          final FirebaseFirestore _db;
          UserRepositoryImpl(this._db);
          Future<void> saveUser(String id) => _db.collection('users').doc(id).set({'id': id});
        }

    - path: "lib/module/home/bloc/home_bloc/home_bloc.dart"
      content: |
        import 'package:flutter_bloc/flutter_bloc.dart';
        import 'package:rxdart/rxdart.dart';
        typedef Evt<X> = EventTransformer<X>;
        Evt<E> debounceSwitchMap<E>(Duration d) =>
          (events, mapper) => events.debounceTime(d).switchMap(mapper);
        class HomeBloc extends Bloc<int, int> {
          HomeBloc(): super(0) {
            on<int>((e, emit) => emit(state + 1), transformer: debounceSwitchMap(const Duration(milliseconds: 300)));
          }
        }

    - path: "lib/feature/home/bloc/home_bloc.dart"
      content: |
        import 'package:flutter_bloc/flutter_bloc.dart';
        import 'package:get_it/get_it.dart';
        import 'package:injectable/injectable.dart';
        @Injectable()
        class HomeBloc extends Bloc<int, int> {
          HomeBloc(): _repo = GetIt.I<UserRepository>(), super(0);
          final UserRepository _repo;
        }

    - path: "lib/module/home/bloc/home_bloc.dart"
      content: |
        import 'package:bloc/bloc.dart';
        import '../../repository/things_repository/fetch_filter.dart';
        import '../../repository/things_repository/thing_repository.dart';
        
        class HomeBloc extends Bloc<HomeEvent, HomeState> {
          HomeBloc({required ThingRepositoryI thingRepository})
              : _thingRepository = thingRepository,
                super(const HomeState());
        
          final ThingRepositoryI _thingRepository;
        
          void _applyTagFilters(Set<String> tagIds) {
            FetchThingsFilter filter;
            if (tagIds.isEmpty) {
              filter = const EmptyThingsFilter();
            } else if (tagIds.length == 1) {
              filter = TagThingsFilter(tagId: tagIds.first);
            } else {
              filter = MultipleTagsThingsFilter(tagIds: tagIds);
            }
            _thingRepository.fetch(filter);
          }
        }

    - path: "lib/module/home/bloc/home_bloc_with_search.dart"
      content: |
        import 'package:bloc/bloc.dart';
        import '../../repository/tag_repository/tag_repository.dart';
        import '../../repository/tag_repository/tag_filter.dart';
        
        class HomeBloc extends Bloc<HomeEvent, HomeState> {
          HomeBloc({required TagRepositoryI tagRepository})
              : _tagRepository = tagRepository,
                super(const HomeState());
        
          final TagRepositoryI _tagRepository;
        
          Future<void> _searchTags(String query) async {
            final tagsStream = await _tagRepository.fetch(SearchByTextTagsFilter(text: query));
            // –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
          }
        }
